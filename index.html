<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>SODmAX Pro - Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡</title>
    <style>
        * { font-family: Tahoma, sans-serif; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #0a0f1c 0%, #121828 100%); color: white; margin: 0; padding: 20px; min-height: 100vh; }
        .container { max-width: 500px; margin: 30px auto; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        h2 { text-align: center; color: #00d4aa; margin-bottom: 25px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #94a3b8; font-size: 14px; }
        input { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; font-size: 16px; }
        input:focus { outline: none; border-color: #0066ff; box-shadow: 0 0 0 2px rgba(0, 102, 255, 0.2); }
        .btn { width: 100%; padding: 14px; border-radius: 8px; border: none; color: white; font-weight: bold; font-size: 16px; cursor: pointer; margin: 8px 0; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        .btn-primary { background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%); }
        .btn-success { background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%); }
        .btn-warning { background: linear-gradient(135deg, #ff6b35 0%, #ff5722 100%); }
        .btn-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .message { padding: 12px 15px; border-radius: 8px; margin: 15px 0; display: none; }
        .success { background: rgba(16, 185, 129, 0.2); border: 1px solid #10b981; color: #10b981; display: block; }
        .error { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #ef4444; display: block; }
        .info { background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; color: #3b82f6; display: block; }
        .stats { background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px; margin-top: 20px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: #94a3b8; }
        .stat-value { color: white; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ® SODmAX Pro - Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡</h2>
        <div id="message" class="message"></div>
        
        <div class="input-group">
            <label>Ø§ÛŒÙ…ÛŒÙ„:</label>
            <input type="email" id="email" placeholder="example@gmail.com" value="test@sodmax.com">
        </div>
        <div class="input-group">
            <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
            <input type="password" id="password" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ±" value="123456">
        </div>
        <div class="input-group">
            <label>Ù†Ø§Ù… Ú©Ø§Ù…Ù„:</label>
            <input type="text" id="fullName" placeholder="Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ" value="Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª">
        </div>
        
        <button class="btn btn-primary" id="registerBtn"><span>ğŸ“</span> Ø«Ø¨Øª Ù†Ø§Ù…</button>
        <button class="btn btn-success" id="loginBtn"><span>ğŸ”‘</span> ÙˆØ±ÙˆØ¯</button>
        <button class="btn btn-warning" id="mineBtn"><span>â›ï¸</span> Ø§Ø³ØªØ®Ø±Ø§Ø¬ 100 SOD</button>
        <button class="btn btn-purple" id="checkBtn"><span>ğŸ‘¤</span> Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª</button>
        
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-row"><span class="stat-label">Ú©Ø§Ø±Ø¨Ø±:</span><span class="stat-value" id="statUser">-</span></div>
            <div class="stat-row"><span class="stat-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ SOD:</span><span class="stat-value" id="statSOD">0</span></div>
            <div class="stat-row"><span class="stat-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ USDT:</span><span class="stat-value" id="statUSDT">0</span></div>
            <div class="stat-row"><span class="stat-label">Ø³Ø·Ø­:</span><span class="stat-value" id="statLevel">1</span></div>
            <div class="stat-row"><span class="stat-label">Ú©Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬:</span><span class="stat-value" id="statTotalMined">0</span></div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; color: #94a3b8; font-size: 12px;">
            ØªÙˆØ³Ø¹Ù‡ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· SODmAX Pro
        </div>
    </div>

    <script type="module">
        // =============================================
        // SODmAX Pro - Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ (Ø¨Ø¯ÙˆÙ† supabase.raw)
        // =============================================
        
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
        
        // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Supabase Ø´Ù…Ø§
        const supabaseUrl = 'https://ttcwbmflesuoyniwoszl.supabase.co'
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0Y3dibWZsZXN1b3luaXdvc3psIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NTQ3ODIsImV4cCI6MjA4MTQzMDc4Mn0.XTJxd_fXWsrLkvbtV0oX5gPIRI00sq-PVIgR1JpAlQ0'
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey)
        
        // Ø¹Ù†Ø§ØµØ± DOM
        const messageEl = document.getElementById('message')
        const registerBtn = document.getElementById('registerBtn')
        const loginBtn = document.getElementById('loginBtn')
        const mineBtn = document.getElementById('mineBtn')
        const checkBtn = document.getElementById('checkBtn')
        const statsEl = document.getElementById('stats')
        
        // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
        function showMessage(text, type = 'info') {
            messageEl.textContent = text
            messageEl.className = `message ${type}`
            console.log(`${type}: ${text}`)
        }
        
        function updateStats(userData) {
            if (userData) {
                statsEl.style.display = 'block'
                document.getElementById('statUser').textContent = userData.email || '-'
                document.getElementById('statSOD').textContent = (userData.balance?.sod_balance || 0).toLocaleString('fa-IR') + ' SOD'
                document.getElementById('statUSDT').textContent = (userData.balance?.usdt_balance || 0).toFixed(4) + ' USDT'
                document.getElementById('statLevel').textContent = userData.profile?.user_level || 1
                document.getElementById('statTotalMined').textContent = (userData.profile?.total_mined || 0).toLocaleString('fa-IR') + ' SOD'
            } else {
                statsEl.style.display = 'none'
            }
        }
        
        // 1. ØªØ§Ø¨Ø¹ Ø«Ø¨Øª Ù†Ø§Ù… (Ø³Ø§Ø¯Ù‡)
        async function registerUser() {
            const email = document.getElementById('email').value.trim()
            const password = document.getElementById('password').value
            const fullName = document.getElementById('fullName').value.trim()
            
            if (!email || !password || !fullName) {
                showMessage('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error')
                return
            }
            
            if (password.length < 6) {
                showMessage('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯', 'error')
                return
            }
            
            showMessage('â³ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ù†Ø§Ù…...', 'info')
            registerBtn.disabled = true
            
            try {
                // Ø«Ø¨Øª Ù†Ø§Ù… Ø¯Ø± Auth
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: { data: { full_name: fullName } }
                })
                
                if (authError) {
                    // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ ÙˆØ§Ø±Ø¯ Ø´Ùˆ
                    if (authError.message.includes('already registered')) {
                        const loginResult = await loginUserDirect(email, password)
                        if (loginResult.success) {
                            showMessage('âœ… ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø´Ø¯ÛŒØ¯', 'success')
                            registerBtn.disabled = false
                            return
                        }
                    }
                    throw authError
                }
                
                showMessage('âœ… Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯', 'success')
                
                // Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†
                await new Promise(resolve => setTimeout(resolve, 1000))
                
                // ÙˆØ§Ø±Ø¯ Ø´Ùˆ
                const loginResult = await loginUserDirect(email, password)
                if (loginResult.success) {
                    showMessage('ğŸ‰ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ø´Ø¯ÛŒØ¯! Û±,Û°Û°Û°,Û°Û°Û° SOD Ù‡Ø¯ÛŒÙ‡ Ú¯Ø±ÙØªÛŒØ¯.', 'success')
                    
                    // Ø§ÛŒØ¬Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
                    await createUserRecords(loginResult.user.id, email, fullName)
                    
                    // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª
                    const userData = await getUserData(loginResult.user.id)
                    updateStats(userData)
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù…:', error)
                showMessage(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø§Ù…: ${error.message}`, 'error')
            } finally {
                registerBtn.disabled = false
            }
        }
        
        // 2. ØªØ§Ø¨Ø¹ ÙˆØ±ÙˆØ¯ Ù…Ø³ØªÙ‚ÛŒÙ…
        async function loginUserDirect(email, password) {
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                })
                
                if (error) throw error
                
                return { success: true, user: data.user }
            } catch (error) {
                return { success: false, error: error.message }
            }
        }
        
        // 3. ØªØ§Ø¨Ø¹ ÙˆØ±ÙˆØ¯
        async function loginUser() {
            const email = document.getElementById('email').value.trim()
            const password = document.getElementById('password').value
            
            if (!email || !password) {
                showMessage('Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error')
                return
            }
            
            showMessage('â³ Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...', 'info')
            loginBtn.disabled = true
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                })
                
                if (error) {
                    if (error.message.includes('Invalid login credentials')) {
                        showMessage('Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª', 'error')
                    } else {
                        showMessage(`Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ${error.message}`, 'error')
                    }
                    loginBtn.disabled = false
                    return
                }
                
                showMessage(`âœ… Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${data.user.email}`, 'success')
                
                // Ø§ÛŒØ¬Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù†Ø¯
                await createUserRecords(data.user.id, data.user.email, data.user.user_metadata?.full_name)
                
                // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª
                const userData = await getUserData(data.user.id)
                updateStats(userData)
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ÛŒ ÙˆØ±ÙˆØ¯:', error)
                showMessage('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…', 'error')
            } finally {
                loginBtn.disabled = false
            }
        }
        
        // 4. ØªØ§Ø¨Ø¹ Ø§Ø³ØªØ®Ø±Ø§Ø¬ (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ - Ø¨Ø¯ÙˆÙ† supabase.raw)
        async function mineSOD() {
            const user = await getCurrentUser()
            
            if (!user) {
                showMessage('âŒ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'error')
                return
            }
            
            showMessage('â›ï¸ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬...', 'info')
            mineBtn.disabled = true
            
            try {
                // Ù…Ù‚Ø¯Ø§Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬
                const minedAmount = 100
                
                // 1. Ø§Ø¨ØªØ¯Ø§ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†
                await createUserRecords(user.id, user.email, user.user_metadata?.full_name)
                
                // 2. Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ
                const { data: currentBalance, error: balanceError } = await supabase
                    .from('user_balances')
                    .select('sod_balance, usdt_balance')
                    .eq('user_id', user.id)
                    .single()
                
                let newBalance
                
                if (balanceError || !currentBalance) {
                    // Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªØŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†
                    newBalance = 1000000 + minedAmount
                    
                    const { error: createError } = await supabase
                        .from('user_balances')
                        .insert({
                            user_id: user.id,
                            sod_balance: newBalance,
                            usdt_balance: 0,
                            last_update: new Date().toISOString()
                        })
                    
                    if (createError) throw createError
                    
                } else {
                    // Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªØŒ Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†
                    newBalance = currentBalance.sod_balance + minedAmount
                    
                    const { error: updateError } = await supabase
                        .from('user_balances')
                        .update({
                            sod_balance: newBalance,
                            last_update: new Date().toISOString()
                        })
                        .eq('user_id', user.id)
                    
                    if (updateError) throw updateError
                }
                
                // 3. Ø¢Ù¾Ø¯ÛŒØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                // Ø§Ø¨ØªØ¯Ø§ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¨Ú¯ÛŒØ±
                const { data: currentProfile } = await supabase
                    .from('user_profiles')
                    .select('total_mined, user_level, mining_power')
                    .eq('user_id', user.id)
                    .single()
                
                const currentTotalMined = currentProfile?.total_mined || 0
                const newTotalMined = currentTotalMined + minedAmount
                
                const { error: profileError } = await supabase
                    .from('user_profiles')
                    .upsert({
                        user_id: user.id,
                        total_mined: newTotalMined,
                        user_level: currentProfile?.user_level || 1,
                        mining_power: currentProfile?.mining_power || 10,
                        last_active: new Date().toISOString()
                    })
                
                if (profileError) throw profileError
                
                // 4. Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´
                const { error: transactionError } = await supabase
                    .from('transactions')
                    .insert({
                        user_id: user.id,
                        transaction_type: 'mining',
                        amount: minedAmount,
                        currency: 'SOD',
                        description: `Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${minedAmount} SOD`,
                        created_at: new Date().toISOString()
                    })
                
                if (transactionError) throw transactionError
                
                showMessage(`âœ… ${minedAmount} SOD Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯! Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${newBalance.toLocaleString('fa-IR')} SOD`, 'success')
                
                // 5. Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª
                const userData = await getUserData(user.id)
                updateStats(userData)
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬:', error)
                showMessage(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬: ${error.message}`, 'error')
            } finally {
                mineBtn.disabled = false
            }
        }
        
        // 5. ØªØ§Ø¨Ø¹ Ø§ÛŒØ¬Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
        async function createUserRecords(userId, email, fullName = 'Ú©Ø§Ø±Ø¨Ø±') {
            try {
                // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¬Ø¯ÙˆÙ„ users
                const { data: userExists } = await supabase
                    .from('users')
                    .select('id')
                    .eq('id', userId)
                    .single()
                    .catch(() => ({ data: null }))
                
                if (!userExists) {
                    // Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±
                    await supabase
                        .from('users')
                        .insert({
                            id: userId,
                            email: email,
                            full_name: fullName,
                            referral_code: 'USER' + Date.now(),
                            created_at: new Date().toISOString()
                        })
                        .catch(e => console.warn('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±:', e.message))
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                const { data: balanceExists } = await supabase
                    .from('user_balances')
                    .select('user_id')
                    .eq('user_id', userId)
                    .single()
                    .catch(() => ({ data: null }))
                
                if (!balanceExists) {
                    // Ø§ÛŒØ¬Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                    await supabase
                        .from('user_balances')
                        .insert({
                            user_id: userId,
                            sod_balance: 1000000,
                            usdt_balance: 0,
                            last_update: new Date().toISOString()
                        })
                        .catch(e => console.warn('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ:', e.message))
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                const { data: profileExists } = await supabase
                    .from('user_profiles')
                    .select('user_id')
                    .eq('user_id', userId)
                    .single()
                    .catch(() => ({ data: null }))
                
                if (!profileExists) {
                    // Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                    await supabase
                        .from('user_profiles')
                        .insert({
                            user_id: userId,
                            user_level: 1,
                            mining_power: 10,
                            total_mined: 0,
                            last_active: new Date().toISOString()
                        })
                        .catch(e => console.warn('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„:', e.message))
                }
                
            } catch (error) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± createUserRecords:', error.message)
            }
        }
        
        // 6. ØªØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª
        async function checkStatus() {
            const user = await getCurrentUser()
            
            if (!user) {
                showMessage('âŒ Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª', 'error')
                statsEl.style.display = 'none'
                return
            }
            
            showMessage('ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...', 'info')
            
            try {
                const userData = await getUserData(user.id)
                
                if (userData) {
                    showMessage(`âœ… Ú©Ø§Ø±Ø¨Ø±: ${user.email}`, 'success')
                    updateStats(userData)
                } else {
                    showMessage('âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error')
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ:', error)
                showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'error')
            }
        }
        
        // 7. ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
        async function getCurrentUser() {
            try {
                const { data: { user } } = await supabase.auth.getUser()
                return user
            } catch (error) {
                return null
            }
        }
        
        async function getUserData(userId) {
            try {
                // Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                const { data: balanceData, error: balanceError } = await supabase
                    .from('user_balances')
                    .select('sod_balance, usdt_balance')
                    .eq('user_id', userId)
                    .single()
                    .catch(() => ({ data: null, error: true }))
                
                // Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                const { data: profileData, error: profileError } = await supabase
                    .from('user_profiles')
                    .select('user_level, mining_power, total_mined')
                    .eq('user_id', userId)
                    .single()
                    .catch(() => ({ data: null, error: true }))
                
                // Ø¯Ø±ÛŒØ§ÙØª Ø§ÛŒÙ…ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±
                const { data: authData } = await supabase.auth.getUser()
                
                return {
                    email: authData?.user?.email || 'Ú©Ø§Ø±Ø¨Ø±',
                    balance: balanceData || { sod_balance: 1000000, usdt_balance: 0 },
                    profile: profileData || { user_level: 1, mining_power: 10, total_mined: 0 }
                }
            } catch (error) {
                return {
                    email: 'Ú©Ø§Ø±Ø¨Ø±',
                    balance: { sod_balance: 1000000, usdt_balance: 0 },
                    profile: { user_level: 1, mining_power: 10, total_mined: 0 }
                }
            }
        }
        
        // 8. Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
        registerBtn.addEventListener('click', registerUser)
        loginBtn.addEventListener('click', loginUser)
        mineBtn.addEventListener('click', mineSOD)
        checkBtn.addEventListener('click', checkStatus)
        
        // 9. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Auth
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('ÙˆØ¶Ø¹ÛŒØª Auth:', event, session?.user?.email)
            
            if (event === 'SIGNED_IN' && session?.user) {
                showMessage(`ğŸ‘‹ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${session.user.email}`, 'success')
                getUserData(session.user.id).then(updateStats)
            }
            
            if (event === 'SIGNED_OUT') {
                statsEl.style.display = 'none'
                showMessage('Ø§Ø² Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯', 'info')
            }
        })
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        setTimeout(async () => {
            const user = await getCurrentUser()
            if (user) {
                showMessage(`ğŸ‘‹ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${user.email}`, 'success')
                const userData = await getUserData(user.id)
                updateStats(userData)
            }
        }, 1000)
        
        console.log('âœ… SODmAX Pro Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!')
    </script>
</body>
</html>

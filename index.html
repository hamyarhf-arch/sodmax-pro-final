<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>SODmAX Pro - Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§</title>
    <style>
        * { font-family: Tahoma, sans-serif; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #0a0f1c 0%, #121828 100%); color: white; margin: 0; padding: 20px; min-height: 100vh; }
        .container { max-width: 500px; margin: 30px auto; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        h2 { text-align: center; color: #00d4aa; margin-bottom: 25px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #94a3b8; font-size: 14px; }
        input { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; font-size: 16px; }
        input:focus { outline: none; border-color: #0066ff; box-shadow: 0 0 0 2px rgba(0, 102, 255, 0.2); }
        .btn { width: 100%; padding: 14px; border-radius: 8px; border: none; color: white; font-weight: bold; font-size: 16px; cursor: pointer; margin: 8px 0; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        .btn-primary { background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%); }
        .btn-success { background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%); }
        .btn-warning { background: linear-gradient(135deg, #ff6b35 0%, #ff5722 100%); }
        .btn-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .message { padding: 12px 15px; border-radius: 8px; margin: 15px 0; display: none; }
        .success { background: rgba(16, 185, 129, 0.2); border: 1px solid #10b981; color: #10b981; display: block; }
        .error { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #ef4444; display: block; }
        .info { background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; color: #3b82f6; display: block; }
        .stats { background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px; margin-top: 20px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: #94a3b8; }
        .stat-value { color: white; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ® SODmAX Pro - Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</h2>
        <div id="message" class="message"></div>
        
        <div class="input-group">
            <label>Ø§ÛŒÙ…ÛŒÙ„:</label>
            <input type="email" id="email" placeholder="example@gmail.com" value="test@sodmax.com">
        </div>
        <div class="input-group">
            <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
            <input type="password" id="password" placeholder="Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ±" value="123456">
        </div>
        <div class="input-group">
            <label>Ù†Ø§Ù… Ú©Ø§Ù…Ù„:</label>
            <input type="text" id="fullName" placeholder="Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ" value="Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª">
        </div>
        
        <button class="btn btn-primary" id="registerBtn"><span>ğŸ“</span> Ø«Ø¨Øª Ù†Ø§Ù…</button>
        <button class="btn btn-success" id="loginBtn"><span>ğŸ”‘</span> ÙˆØ±ÙˆØ¯</button>
        <button class="btn btn-warning" id="mineBtn"><span>â›ï¸</span> Ø§Ø³ØªØ®Ø±Ø§Ø¬ 100 SOD</button>
        <button class="btn btn-purple" id="checkBtn"><span>ğŸ‘¤</span> Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª</button>
        <button class="btn" id="fixBtn" style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"><span>ğŸ”§</span> ØªØ¹Ù…ÛŒØ± Ø¯ÛŒØªØ§Ø¨ÛŒØ³</button>
        
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-row"><span class="stat-label">Ú©Ø§Ø±Ø¨Ø±:</span><span class="stat-value" id="statUser">-</span></div>
            <div class="stat-row"><span class="stat-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ SOD:</span><span class="stat-value" id="statSOD">0</span></div>
            <div class="stat-row"><span class="stat-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ USDT:</span><span class="stat-value" id="statUSDT">0</span></div>
            <div class="stat-row"><span class="stat-label">Ø³Ø·Ø­:</span><span class="stat-value" id="statLevel">1</span></div>
            <div class="stat-row"><span class="stat-label">Ú©Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬:</span><span class="stat-value" id="statTotalMined">0</span></div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; color: #94a3b8; font-size: 12px;">
            ØªÙˆØ³Ø¹Ù‡ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· SODmAX Pro
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
        
        const supabaseUrl = 'https://qacsoynvoypcwnttfpwh.supabase.co'
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhY3NveW52b3lwY3dudHRmcHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4Mjk0NTYsImV4cCI6MjA4MTQwNTQ1Nn0.uvg5O4i89m2w6D0v2YZ7-l7YuERy94j83sSVt-b4uoA'
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey)
        
        const messageEl = document.getElementById('message')
        const registerBtn = document.getElementById('registerBtn')
        const loginBtn = document.getElementById('loginBtn')
        const mineBtn = document.getElementById('mineBtn')
        const checkBtn = document.getElementById('checkBtn')
        const fixBtn = document.getElementById('fixBtn')
        const statsEl = document.getElementById('stats')
        
        function showMessage(text, type = 'info') {
            messageEl.textContent = text
            messageEl.className = `message ${type}`
            console.log(`${type}: ${text}`)
        }
        
        function updateStats(userData) {
            if (userData) {
                statsEl.style.display = 'block'
                document.getElementById('statUser').textContent = userData.email || '-'
                document.getElementById('statSOD').textContent = (userData.balance?.sod_balance || 0).toLocaleString('fa-IR') + ' SOD'
                document.getElementById('statUSDT').textContent = (userData.balance?.usdt_balance || 0).toFixed(4) + ' USDT'
                document.getElementById('statLevel').textContent = userData.profile?.user_level || 1
                document.getElementById('statTotalMined').textContent = (userData.profile?.total_mined || 0).toLocaleString('fa-IR') + ' SOD'
            } else {
                statsEl.style.display = 'none'
            }
        }
        
        // 1. ØªØ§Ø¨Ø¹ ØªØ¹Ù…ÛŒØ± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        async function fixDatabase() {
            showMessage('ğŸ”§ Ø¯Ø± Ø­Ø§Ù„ ØªØ¹Ù…ÛŒØ± Ø¯ÛŒØªØ§Ø¨ÛŒØ³...', 'info')
            fixBtn.disabled = true
            
            try {
                // Ú©Ø¯ SQL Ø¨Ø±Ø§ÛŒ ØªØ¹Ù…ÛŒØ±
                const fixSQL = `
                    -- Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ users Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                    CREATE TABLE IF NOT EXISTS users (
                        id UUID PRIMARY KEY,
                        email TEXT UNIQUE NOT NULL,
                        full_name TEXT NOT NULL,
                        referral_code TEXT UNIQUE,
                        is_admin BOOLEAN DEFAULT false,
                        created_at TIMESTAMPTZ DEFAULT NOW()
                    );
                    
                    -- Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ user_profiles
                    CREATE TABLE IF NOT EXISTS user_profiles (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        user_id UUID,
                        user_level INT DEFAULT 1,
                        mining_power INT DEFAULT 10,
                        total_mined BIGINT DEFAULT 0,
                        last_active TIMESTAMPTZ DEFAULT NOW()
                    );
                    
                    -- Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ user_balances (Ø¨Ø¯ÙˆÙ† FOREIGN KEY)
                    CREATE TABLE IF NOT EXISTS user_balances (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        user_id UUID,
                        sod_balance BIGINT DEFAULT 1000000,
                        usdt_balance DECIMAL(10,4) DEFAULT 0,
                        last_update TIMESTAMPTZ DEFAULT NOW()
                    );
                    
                    -- Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ transactions
                    CREATE TABLE IF NOT EXISTS transactions (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        user_id UUID,
                        transaction_type TEXT NOT NULL,
                        amount DECIMAL(20,4) NOT NULL,
                        currency TEXT NOT NULL,
                        description TEXT,
                        created_at TIMESTAMPTZ DEFAULT NOW()
                    );
                    
                    -- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Auth Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„ users
                    INSERT INTO users (id, email, full_name, created_at)
                    SELECT 
                        au.id, 
                        au.email,
                        COALESCE(au.raw_user_meta_data->>'full_name', 'Ú©Ø§Ø±Ø¨Ø±'),
                        au.created_at
                    FROM auth.users au
                    LEFT JOIN users u ON au.id = u.id
                    WHERE u.id IS NULL
                    ON CONFLICT (id) DO NOTHING;
                    
                    SELECT 'âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ØªØ¹Ù…ÛŒØ± Ø´Ø¯' as result;
                `
                
                const { error } = await supabase.rpc('exec_sql', { sql_query: fixSQL }).catch(async () => {
                    // Ø§Ú¯Ø± ØªØ§Ø¨Ø¹ exec_sql ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ø§ Ø¯Ø³ØªÙˆØ±Ø§Øª Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
                    await createTablesManually()
                })
                
                if (error) {
                    await createTablesManually()
                }
                
                showMessage('âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ¹Ù…ÛŒØ± Ø´Ø¯', 'success')
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ÛŒ ØªØ¹Ù…ÛŒØ±:', error)
                showMessage('âš ï¸ Ø¨Ø±Ø®ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯. Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.', 'info')
            } finally {
                fixBtn.disabled = false
            }
        }
        
        async function createTablesManually() {
            // Ø¬Ø¯Ø§ÙˆÙ„ Ø±Ø§ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†
            const tables = [
                `CREATE TABLE IF NOT EXISTS users (
                    id UUID PRIMARY KEY,
                    email TEXT UNIQUE NOT NULL,
                    full_name TEXT NOT NULL,
                    referral_code TEXT UNIQUE,
                    is_admin BOOLEAN DEFAULT false,
                    created_at TIMESTAMPTZ DEFAULT NOW()
                )`,
                `CREATE TABLE IF NOT EXISTS user_profiles (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    user_id UUID,
                    user_level INT DEFAULT 1,
                    mining_power INT DEFAULT 10,
                    total_mined BIGINT DEFAULT 0,
                    last_active TIMESTAMPTZ DEFAULT NOW()
                )`,
                `CREATE TABLE IF NOT EXISTS user_balances (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    user_id UUID,
                    sod_balance BIGINT DEFAULT 1000000,
                    usdt_balance DECIMAL(10,4) DEFAULT 0,
                    last_update TIMESTAMPTZ DEFAULT NOW()
                )`,
                `CREATE TABLE IF NOT EXISTS transactions (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    user_id UUID,
                    transaction_type TEXT NOT NULL,
                    amount DECIMAL(20,4) NOT NULL,
                    currency TEXT NOT NULL,
                    description TEXT,
                    created_at TIMESTAMPTZ DEFAULT NOW()
                )`
            ]
            
            for (const sql of tables) {
                try {
                    await supabase.rpc('exec_sql', { sql_query: sql })
                } catch (e) {
                    console.warn('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„:', e.message)
                }
            }
        }
        
        // 2. ØªØ§Ø¨Ø¹ Ø«Ø¨Øª Ù†Ø§Ù… (Ú©Ø§Ù…Ù„ Ùˆ Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§)
        async function registerUser() {
            const email = document.getElementById('email').value.trim()
            const password = document.getElementById('password').value
            const fullName = document.getElementById('fullName').value.trim()
            
            if (!email || !password || !fullName) {
                showMessage('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error')
                return
            }
            
            if (password.length < 6) {
                showMessage('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯', 'error')
                return
            }
            
            showMessage('â³ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ù†Ø§Ù…...', 'info')
            registerBtn.disabled = true
            
            try {
                // 1. Ø«Ø¨Øª Ù†Ø§Ù… Ø¯Ø± Auth
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: { data: { full_name: fullName } }
                })
                
                if (authError) {
                    if (authError.message.includes('already registered')) {
                        showMessage('Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª', 'error')
                        registerBtn.disabled = false
                        return
                    }
                    throw authError
                }
                
                showMessage('âœ… Ø«Ø¨Øª Ù†Ø§Ù… Ø§ÙˆÙ„ÛŒÙ‡ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯', 'success')
                
                // 2. Ø§ÛŒØ¬Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯ Ø¯Ø± users
                try {
                    await supabase.from('users').upsert({
                        id: authData.user.id,
                        email: email,
                        full_name: fullName,
                        referral_code: 'USER' + Date.now(),
                        created_at: new Date().toISOString()
                    })
                } catch (e) { console.warn('Ø®Ø·Ø§ÛŒ users:', e.message) }
                
                // 3. Ø§ÛŒØ¬Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                try {
                    await supabase.from('user_balances').upsert({
                        user_id: authData.user.id,
                        sod_balance: 1000000,
                        usdt_balance: 0,
                        last_update: new Date().toISOString()
                    })
                } catch (e) { console.warn('Ø®Ø·Ø§ÛŒ balances:', e.message) }
                
                // 4. Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§Ø²ÛŒ
                try {
                    await supabase.from('user_profiles').upsert({
                        user_id: authData.user.id,
                        user_level: 1,
                        mining_power: 10,
                        total_mined: 0,
                        last_active: new Date().toISOString()
                    })
                } catch (e) { console.warn('Ø®Ø·Ø§ÛŒ profiles:', e.message) }
                
                showMessage('ğŸ‰ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø´Ø¯! Û±,Û°Û°Û°,Û°Û°Û° SOD Ù‡Ø¯ÛŒÙ‡ Ú¯Ø±ÙØªÛŒØ¯.', 'success')
                
                // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª
                const user = await getCurrentUser()
                if (user) {
                    const userData = await getUserData(user.id)
                    updateStats(userData)
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù…:', error)
                showMessage(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø§Ù…: ${error.message}`, 'error')
            } finally {
                registerBtn.disabled = false
            }
        }
        
        // 3. ØªØ§Ø¨Ø¹ ÙˆØ±ÙˆØ¯
        async function loginUser() {
            const email = document.getElementById('email').value.trim()
            const password = document.getElementById('password').value
            
            if (!email || !password) {
                showMessage('Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error')
                return
            }
            
            showMessage('â³ Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...', 'info')
            loginBtn.disabled = true
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                })
                
                if (error) {
                    if (error.message.includes('Invalid login credentials')) {
                        showMessage('Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª', 'error')
                    } else {
                        showMessage(`Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ${error.message}`, 'error')
                    }
                    loginBtn.disabled = false
                    return
                }
                
                showMessage(`âœ… Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${data.user.email}`, 'success')
                
                // Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯
                await ensureUserRecords(data.user.id, data.user.email, data.user.user_metadata?.full_name)
                
                // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª
                const userData = await getUserData(data.user.id)
                updateStats(userData)
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ÛŒ ÙˆØ±ÙˆØ¯:', error)
                showMessage('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…', 'error')
            } finally {
                loginBtn.disabled = false
            }
        }
        
        // 4. ØªØ§Ø¨Ø¹ Ø§Ø³ØªØ®Ø±Ø§Ø¬ (Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§ÛŒ FOREIGN KEY)
        async function mineSOD() {
            const user = await getCurrentUser()
            
            if (!user) {
                showMessage('âŒ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'error')
                return
            }
            
            showMessage('â›ï¸ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬...', 'info')
            mineBtn.disabled = true
            
            try {
                // Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯
                await ensureUserRecords(user.id, user.email, user.user_metadata?.full_name)
                
                const minedAmount = 100
                
                // 1. Ø¢Ù¾Ø¯ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                const { data: currentBalance } = await supabase
                    .from('user_balances')
                    .select('sod_balance')
                    .eq('user_id', user.id)
                    .single()
                
                const currentSOD = currentBalance?.sod_balance || 1000000
                const newBalance = currentSOD + minedAmount
                
                await supabase
                    .from('user_balances')
                    .upsert({
                        user_id: user.id,
                        sod_balance: newBalance,
                        last_update: new Date().toISOString()
                    })
                
                // 2. Ø¢Ù¾Ø¯ÛŒØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                await supabase
                    .from('user_profiles')
                    .upsert({
                        user_id: user.id,
                        total_mined: supabase.raw('COALESCE(total_mined, 0) + ' + minedAmount),
                        last_active: new Date().toISOString()
                    })
                
                // 3. Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´
                await supabase
                    .from('transactions')
                    .insert({
                        user_id: user.id,
                        transaction_type: 'mining',
                        amount: minedAmount,
                        currency: 'SOD',
                        description: `Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${minedAmount} SOD`,
                        created_at: new Date().toISOString()
                    })
                
                showMessage(`âœ… ${minedAmount} SOD Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯! Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${newBalance.toLocaleString('fa-IR')} SOD`, 'success')
                
                // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª
                const userData = await getUserData(user.id)
                updateStats(userData)
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬:', error)
                showMessage(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬: ${error.message}`, 'error')
            } finally {
                mineBtn.disabled = false
            }
        }
        
        // 5. ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ: Ù…Ø·Ù…Ø¦Ù† Ø´Ø¯Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
        async function ensureUserRecords(userId, email, fullName = 'Ú©Ø§Ø±Ø¨Ø±') {
            try {
                // Ø¨Ø±Ø±Ø³ÛŒ users
                const { data: userExists } = await supabase
                    .from('users')
                    .select('id')
                    .eq('id', userId)
                    .single()
                
                if (!userExists) {
                    await supabase.from('users').upsert({
                        id: userId,
                        email: email,
                        full_name: fullName,
                        created_at: new Date().toISOString()
                    })
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ user_balances
                const { data: balanceExists } = await supabase
                    .from('user_balances')
                    .select('user_id')
                    .eq('user_id', userId)
                    .single()
                
                if (!balanceExists) {
                    await supabase.from('user_balances').upsert({
                        user_id: userId,
                        sod_balance: 1000000,
                        usdt_balance: 0,
                        last_update: new Date().toISOString()
                    })
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ user_profiles
                const { data: profileExists } = await supabase
                    .from('user_profiles')
                    .select('user_id')
                    .eq('user_id', userId)
                    .single()
                
                if (!profileExists) {
                    await supabase.from('user_profiles').upsert({
                        user_id: userId,
                        user_level: 1,
                        mining_power: 10,
                        total_mined: 0,
                        last_active: new Date().toISOString()
                    })
                }
                
            } catch (error) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± ensureUserRecords:', error.message)
            }
        }
        
        // 6. ØªØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª
        async function checkStatus() {
            const user = await getCurrentUser()
            
            if (!user) {
                showMessage('âŒ Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª', 'error')
                statsEl.style.display = 'none'
                return
            }
            
            showMessage('ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...', 'info')
            
            try {
                // Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯
                await ensureUserRecords(user.id, user.email, user.user_metadata?.full_name)
                
                const userData = await getUserData(user.id)
                
                if (userData) {
                    showMessage(`âœ… Ú©Ø§Ø±Ø¨Ø±: ${user.email}`, 'success')
                    updateStats(userData)
                } else {
                    showMessage('âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error')
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ:', error)
                showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'error')
            }
        }
        
        // 7. ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
        async function getCurrentUser() {
            const { data: { user } } = await supabase.auth.getUser()
            return user
        }
        
        async function getUserData(userId) {
            try {
                const [balanceRes, profileRes] = await Promise.all([
                    supabase.from('user_balances').select('*').eq('user_id', userId).single(),
                    supabase.from('user_profiles').select('*').eq('user_id', userId).single()
                ])
                
                return {
                    email: (await supabase.auth.getUser()).data.user?.email,
                    balance: balanceRes.data || { sod_balance: 1000000, usdt_balance: 0 },
                    profile: profileRes.data || { user_level: 1, mining_power: 10, total_mined: 0 }
                }
            } catch (error) {
                return {
                    email: (await supabase.auth.getUser()).data.user?.email,
                    balance: { sod_balance: 1000000, usdt_balance: 0 },
                    profile: { user_level: 1, mining_power: 10, total_mined: 0 }
                }
            }
        }
        
        // 8. Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
        registerBtn.addEventListener('click', registerUser)
        loginBtn.addEventListener('click', loginUser)
        mineBtn.addEventListener('click', mineSOD)
        checkBtn.addEventListener('click', checkStatus)
        fixBtn.addEventListener('click', fixDatabase)
        
        // 9. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Auth
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('ÙˆØ¶Ø¹ÛŒØª Auth:', event, session?.user?.email)
            
            if (event === 'SIGNED_IN' && session?.user) {
                showMessage(`ğŸ‘‹ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${session.user.email}`, 'success')
                getUserData(session.user.id).then(updateStats)
            }
            
            if (event === 'SIGNED_OUT') {
                statsEl.style.display = 'none'
                showMessage('Ø§Ø² Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯', 'info')
            }
        })
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        setTimeout(async () => {
            const user = await getCurrentUser()
            if (user) {
                showMessage(`ğŸ‘‹ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${user.email}`, 'success')
                const userData = await getUserData(user.id)
                updateStats(userData)
            }
        }, 1000)
        
        console.log('âœ… SODmAX Pro Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!')
    </script>
</body>
</html>

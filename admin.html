<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª SODmAX Pro</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ admin.html Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯ (Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) */
    </style>
</head>
<body>
    <!-- ØµÙØ­Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù…Ù†ÙˆØ¹ -->
    <div id="accessDenied" class="access-denied" style="display: none;">
        <div>
            <div style="font-size: 80px; margin-bottom: 20px;">ğŸš«</div>
            <h1 style="font-size: 36px; margin-bottom: 20px;">Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù…Ù†ÙˆØ¹</h1>
            <p style="color: var(--text-secondary); font-size: 18px; margin-bottom: 30px; max-width: 500px;">
                Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.
            </p>
            <button onclick="window.location.href='index.html'" style="background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600;">
                Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ
            </button>
        </div>
    </div>
    
    <!-- ØµÙØ­Ù‡ Ù„Ø§Ú¯ÛŒÙ† -->
    <div id="adminLogin" class="login-container" style="display: none;">
        <div class="login-box">
            <h1 class="login-title"><span>ğŸ”</span> ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h1>
            <input type="email" id="adminEmail" class="input-field" placeholder="Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¯ÛŒØ±" value="hamyarhf@gmail.com">
            <input type="password" id="adminPassword" class="input-field" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
            <button class="login-btn" onclick="checkAdminLogin()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„</button>
            <div id="loginError" class="error-msg">âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª</div>
        </div>
    </div>
    
    <!-- Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø§ØµÙ„ÛŒ -->
    <div id="adminPanel" class="admin-container" style="display: none;">
        <!-- Ù‡Ø¯Ø± -->
        <div class="admin-header">
            <h1 class="admin-title">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª SODmAX</h1>
            <button class="logout-btn" onclick="adminLogout()"><span>ğŸšª</span> Ø®Ø±ÙˆØ¬ Ø§Ø² Ù¾Ù†Ù„</button>
        </div>
        
        <!-- ØªØ¨â€ŒÙ‡Ø§ -->
        <div class="tabs-container">
            <div class="tabs">
                <div class="tab active" onclick="showTab('users')">ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† <span id="usersCountBadge" class="badge">0</span></div>
                <div class="tab" onclick="showTab('stats')">ğŸ“Š Ø¢Ù…Ø§Ø±</div>
                <div class="tab" onclick="showTab('controls')">âš™ï¸ Ú©Ù†ØªØ±Ù„</div>
                <div class="tab" onclick="debugStorage()">ğŸ› Ø¯ÛŒØ¨Ø§Ú¯</div>
            </div>
        </div>
        
        <!-- Ø¢Ù…Ø§Ø± -->
        <div class="stats-grid">
            <div class="stat-card"><h3><span>ğŸ‘¥</span> Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„</h3><div class="stat-value" id="activeUsers">Û°</div></div>
            <div class="stat-card"><h3><span>â›ï¸</span> Ú©Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬</h3><div class="stat-value" id="totalMined">Û° SOD</div></div>
            <div class="stat-card"><h3><span>ğŸ’°</span> Ú©Ù„ SOD</h3><div class="stat-value" id="totalSOD">Û° SOD</div></div>
            <div class="stat-card"><h3><span>ğŸ’</span> Ú©Ù„ USDT</h3><div class="stat-value" id="totalUSDT">Û° USDT</div></div>
        </div>
        
        <!-- Ø¬Ø¯ÙˆÙ„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
        <div class="table-container">
            <div class="table-header">
                <div class="table-title"><span>ğŸ“‹</span> Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div class="search-box"><input type="text" class="search-input" id="searchUsers" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±..."></div>
                    <button onclick="showAddUserModal()" style="background: var(--secondary); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">â• Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</button>
                    <button onclick="syncAllUsers()" style="background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">ğŸ”„ Ø³ÛŒÙ†Ú© Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
                </div>
            </div>
            <div style="overflow-x: auto;"><table>
                <thead><tr><th>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±</th><th>Ø§ÛŒÙ…ÛŒÙ„</th><th>SOD</th><th>USDT</th><th>Ø³Ø·Ø­</th><th>Ú©Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬</th><th>ØªØ§Ø±ÛŒØ® Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
                <tbody id="usersList"></tbody>
            </table></div>
        </div>
        
        <!-- Ú©Ù†ØªØ±Ù„ Ù¾Ù†Ù„ (Ù¾Ù†Ù‡Ø§Ù†) -->
        <div id="controlPanel" style="display: none;">
            <div class="control-panel">
                <div class="control-card">
                    <h3><span>â•</span> Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</h3>
                    <div class="form-group"><label class="form-label">Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label><input type="text" class="form-input" id="newUserName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ"></div>
                    <div class="form-group"><label class="form-label">Ø§ÛŒÙ…ÛŒÙ„</label><input type="email" class="form-input" id="newUserEmail" placeholder="example@gmail.com"></div>
                    <div class="form-group"><label class="form-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ SOD</label><input type="number" class="form-input" id="newUserSOD" value="1000000"></div>
                    <button class="login-btn" onclick="createNewUser()" style="background: var(--secondary); margin-top: 20px;">ğŸ‘¤ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</button>
                </div>
                <div class="control-card">
                    <h3><span>âš¡</span> Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø³ØªÙ‡â€ŒØ§ÛŒ</h3>
                    <div class="form-group"><label class="form-label">Ø§ÙØ²ÙˆØ¯Ù† SOD Ø¨Ù‡ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</label><input type="number" class="form-input" id="batchSOD" placeholder="Ù…Ù‚Ø¯Ø§Ø± SOD"></div>
                    <button class="login-btn" onclick="addSODToAll()" style="background: var(--primary); margin-bottom: 15px;">ğŸ’° Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù‡Ù…Ù‡</button>
                    <div class="form-group"><label class="form-label">ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ØªØ³Øª</label><input type="number" class="form-input" id="testUsersCount" value="5" min="1" max="50"></div>
                    <button class="login-btn" onclick="createTestUsers()" style="background: var(--accent);">ğŸ§ª Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ØªØ³Øª</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø± -->
    <div class="modal-overlay" id="editUserModal"><div class="modal-content"></div></div>

    <!-- Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† -->
    <div class="notification" id="notification"></div>

    <script src="supabase-config.js"></script>
    <script>
        // Ú©Ù„Ø§ÛŒÙ†Øª Ø§Ø¯Ù…ÛŒÙ†
        const supabaseAdmin = window.supabase.createClient(
            'https://zoqsgvgbmxrkemcwxwus.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvcXNndmdibXhya2VtY3d4d3VzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NTc4Nzk1MCwiZXhwIjoyMDgxMzYzOTUwfQ.hxIxYP66EhjZyjU_DYquUjci_qYmCATNFkwA3s22ZJU'
        );

        // ==================== ØªÙˆØ§Ø¨Ø¹ Ø§Ø¯Ù…ÛŒÙ† ====================
        async function checkAccess() {
            const user = await SupabaseAPI.getCurrentUser();
            if (!user) {
                document.getElementById('accessDenied').style.display = 'flex';
                return;
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ†
            const { data: userData } = await supabaseAdmin.from('users')
                .select('is_admin').eq('id', user.id).single();
            
            if (userData?.is_admin) {
                showAdminPanel();
            } else {
                document.getElementById('accessDenied').style.display = 'flex';
            }
        }

        async function checkAdminLogin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            
            const result = await SupabaseAPI.signInUser(email, password);
            if (result.success) {
                setTimeout(() => location.reload(), 500);
            } else {
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => { document.getElementById('loginError').style.display = 'none'; }, 3000);
            }
        }

        function showAdminPanel() {
            document.getElementById('adminLogin').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadAdminData();
        }

        function adminLogout() {
            SupabaseAPI.supabase.auth.signOut();
            setTimeout(() => location.reload(), 500);
        }

        async function loadAdminData() {
            await loadStats();
            await loadUsers();
        }

        async function loadStats() {
            // Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            const { count: userCount } = await supabaseAdmin.from('users')
                .select('*', { count: 'exact', head: true });
            document.getElementById('activeUsers').textContent = userCount || 0;
            document.getElementById('usersCountBadge').textContent = userCount || 0;
            
            // Ú©Ù„ SOD Ùˆ USDT
            const { data: balances } = await supabaseAdmin.from('user_balances')
                .select('sod_balance, usdt_balance');
            
            let totalSOD = 0, totalUSDT = 0, totalMined = 0;
            balances.forEach(b => {
                totalSOD += b.sod_balance || 0;
                totalUSDT += b.usdt_balance || 0;
            });
            
            document.getElementById('totalSOD').textContent = formatNumber(totalSOD) + ' SOD';
            document.getElementById('totalUSDT').textContent = totalUSDT.toFixed(4) + ' USDT';
            
            // Ú©Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬
            const { data: profiles } = await supabaseAdmin.from('user_profiles')
                .select('total_mined');
            profiles.forEach(p => { totalMined += p.total_mined || 0; });
            document.getElementById('totalMined').textContent = formatNumber(totalMined) + ' SOD';
        }

        async function loadUsers() {
            const { data: users } = await supabaseAdmin.from('users')
                .select('*, user_profiles(*), user_balances(*)')
                .order('created_at', { ascending: false });
            
            const tbody = document.getElementById('usersList');
            let html = '';
            
            users.forEach(user => {
                html += `<tr>
                    <td>${user.full_name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
                    <td>${user.email}</td>
                    <td>${formatNumber(user.user_balances[0]?.sod_balance || 0)}</td>
                    <td>${(user.user_balances[0]?.usdt_balance || 0).toFixed(4)}</td>
                    <td>${user.user_profiles[0]?.user_level || 1}</td>
                    <td>${formatNumber(user.user_profiles[0]?.total_mined || 0)}</td>
                    <td>${new Date(user.created_at).toLocaleDateString('fa-IR')}</td>
                    <td>
                        <button onclick="editUser('${user.id}')" style="background: rgba(0,212,170,0.2); color: var(--secondary); border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin: 2px;">âœï¸</button>
                        <button onclick="addSOD('${user.id}', 1000000)" style="background: rgba(0,102,255,0.2); color: var(--primary); border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin: 2px;">+1M</button>
                        <button onclick="deleteUser('${user.id}')" style="background: rgba(255,61,0,0.2); color: var(--danger); border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin: 2px;">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="8" style="text-align:center; padding:40px;">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
        }

        async function addSOD(userId, amount) {
            if (!confirm(`Ø§ÙØ²ÙˆØ¯Ù† ${formatNumber(amount)} SOD Ø¨Ù‡ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±ØŸ`)) return;
            
            const { data: current } = await supabaseAdmin.from('user_balances')
                .select('sod_balance').eq('user_id', userId).single();
            
            const newBalance = (current?.sod_balance || 0) + amount;
            
            await supabaseAdmin.from('user_balances')
                .update({ sod_balance: newBalance }).eq('user_id', userId);
            
            alert('âœ… Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
            loadAdminData();
        }

        async function deleteUser(userId) {
            if (!confirm('âš ï¸ Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
            
            await supabaseAdmin.from('users').delete().eq('id', userId);
            alert('âœ… Ú©Ø§Ø±Ø¨Ø± Ø­Ø°Ù Ø´Ø¯');
            loadAdminData();
        }

        async function createNewUser() {
            const name = document.getElementById('newUserName').value;
            const email = document.getElementById('newUserEmail').value;
            const sod = parseInt(document.getElementById('newUserSOD').value) || 1000000;
            
            if (!name || !email) { alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ø§ÛŒÙ…ÛŒÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            
            const password = 'SodMax2024!';
            const result = await SupabaseAPI.signUpUser(email, password, name);
            
            if (result.success) {
                // Ø¢Ù¾Ø¯ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                await supabaseAdmin.from('user_balances')
                    .update({ sod_balance: sod }).eq('user_id', result.user.id);
                
                alert(`âœ… Ú©Ø§Ø±Ø¨Ø± ${name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`);
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserEmail').value = '';
                loadAdminData();
            } else {
                alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±: ' + result.error);
            }
        }

        async function addSODToAll() {
            const amount = parseInt(document.getElementById('batchSOD').value);
            if (!amount || amount <= 0) { alert('Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            
            if (!confirm(`Ø§ÙØ²ÙˆØ¯Ù† ${formatNumber(amount)} SOD Ø¨Ù‡ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ØŸ`)) return;
            
            const { data: balances } = await supabaseAdmin.from('user_balances').select('user_id, sod_balance');
            
            for (const balance of balances) {
                const newBalance = (balance.sod_balance || 0) + amount;
                await supabaseAdmin.from('user_balances')
                    .update({ sod_balance: newBalance }).eq('user_id', balance.user_id);
            }
            
            alert(`âœ… ${formatNumber(amount)} SOD Ø¨Ù‡ ${balances.length} Ú©Ø§Ø±Ø¨Ø± Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯`);
            loadAdminData();
        }

        async function createTestUsers() {
            const count = parseInt(document.getElementById('testUsersCount').value) || 5;
            
            for (let i = 1; i <= count; i++) {
                const email = `test${Date.now()}${i}@test.com`;
                const name = `Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª ${i}`;
                const password = 'Test123!';
                
                await SupabaseAPI.signUpUser(email, password, name);
            }
            
            alert(`âœ… ${count} Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`);
            loadAdminData();
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('controlPanel').style.display = (tabName === 'controls') ? 'block' : 'none';
            if (tabName === 'stats') loadAdminData();
        }

        function syncAllUsers() {
            loadAdminData();
            alert('âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯');
        }

        function debugStorage() {
            console.log('ğŸ” Ø¯ÛŒØ¨Ø§Ú¯ Supabase Storage...');
            alert('âœ… Ú©Ù†Ø³ÙˆÙ„ Ù…Ø±ÙˆØ±Ú¯Ø± (F12) Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯');
            loadAdminData();
        }

        function editUser(userId) {
            alert('âœï¸ Ø§Ù…Ú©Ø§Ù† ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø± Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª');
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
        document.addEventListener('DOMContentLoaded', checkAccess);
    </script>
</body>
</html>
